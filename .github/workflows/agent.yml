name: GPT-4o-mini Agent Run & Auto Commit

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: '作成したいプログラムの指示を入力'
        required: true
        default: 'hello_world.pyを作成して'

jobs:
  run-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Python環境構築
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 依存ライブラリインストール
        run: pip install openai

      - name: GPT-4o-mini エージェント実行
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python - <<EOF
          import os
          from openai import OpenAI

          client = OpenAI(
              base_url="https://models.inference.ai.azure.com",
              api_key=os.environ.get("LLM_API_KEY")
          )

          # モデル名に合わせてプロンプトを最適化
          prompt = "あなたはGPT-4o-miniとして、以下の指示に基づきPythonコードのみを出力してください。解説は不要です。\n指示: ${{ github.event.inputs.task_description }}"
          
          response = client.chat.completions.create(
              messages=[{"role": "user", "content": prompt}],
              model="gpt-4o-mini"
          )

          code = response.choices[0].message.content.strip()
          # Markdownの装飾を除去
          code = code.replace('```python', '').replace('```', '')

          with open('generated_code.py', 'w', encoding='utf-8') as f:
              f.write(code)
          EOF

      - name: 生成されたファイルをコミットしてPush
        run: |
          git config --local user.email "p.w.n.g-444@hotmail.co.jp"
          git config --local user.name "ta-ta-ta-ta"
          git add generated_code.py
          git commit -m "GPT-4o-mini: ${{ github.event.inputs.task_description }}"
          git push